<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Receptor</title></head>
<body>
<h2>Receptor</h2>
<video id="remoteVideo" autoplay playsinline controls></video>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-g5vDBoRBBXRA4sHSSUoSb1mOAzW7dvE",
  authDomain: "screenshare-c9b90.firebaseapp.com",
  databaseURL: "https://screenshare-c9b90-default-rtdb.firebaseio.com",
  projectId: "screenshare-c9b90",
  storageBucket: "screenshare-c9b90.firebasestorage.app",
  messagingSenderId: "773043733347",
  appId: "1:773043733347:web:91aa0217bcf05a11990956",
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const pc = new RTCPeerConnection();
const video = document.getElementById("remoteVideo");
pc.ontrack = (e) => video.srcObject = e.streams[0];

// Crea un ID Ãºnico para este viewer
const viewerRef = push(ref(db, "webrtc/viewers"));
const viewerId = viewerRef.key;

// Escucha la oferta del transmisor
onValue(ref(db, `webrtc/viewers/${viewerId}/offer`), async (snap) => {
  if (!snap.exists()) return;
  const offer = snap.val();
  await pc.setRemoteDescription(offer);

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  set(ref(db, `webrtc/viewers/${viewerId}/answer`), answer);
});

// ICE del transmisor
onValue(ref(db, `webrtc/viewers/${viewerId}/senderCandidate`), async (snap) => {
  if (snap.exists()) await pc.addIceCandidate(snap.val());
});

// Envia ICE propios
pc.onicecandidate = (e) => {
  if (e.candidate) set(ref(db, `webrtc/viewers/${viewerId}/viewerCandidate`), e.candidate.toJSON());
};
</script>
</body>
</html>
